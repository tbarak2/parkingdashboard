@model IEnumerable<ParkingDashboardSample.Models.SiteData>

@{
    ViewBag.Title = "Index";
}

<style>
    tr.Warning td {
        background-color: yellow;
        color: black;
    }

    tr.Faults td {
        background-color: red;
        color: black;
    }

    tr.Ok td {
        background-color: green;
        color: black;
    }
</style>

<h2>Index</h2>

<p>
    @Html.ActionLink("Create New", "Create")
</p>
<div id="tbProducts">
    @Html.Partial("PartialViewSites",Model)
</div>
    <input type="button" id="sendmessage" value="Send" />
    <ul id="discussion"></ul>

    @section scripts
{
        <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
        <script src="~/signalr/hubs"></script>
        <script type="text/javascript">
            var signalRHubInitialized = false;

            $(function () {
                InitializeSignalRHubStore();
            });

            function InitializeSignalRHubStore() {

                if (signalRHubInitialized)
                    return;

                try {
                    var clientHub = $.connection.eventHub;

                    clientHub.client.broadcastMessage = function (message) {
                        if (message === "Refresh")
                            ReloadIndexPartial();
                    };

                    $.connection.hub.start().done(function () {
                        clientHub.server.initialize($("#NotifierEntity").val());
                        signalRHubInitialized = true;
                    });

                } catch (err) {
                    signalRHubInitialized = false;
                }
            };

            function ReloadIndexPartial() {

                $.post('@(Url.Action("PartialTable",
                              "SiteData", null, Request.Url.Scheme))')
                    .done(function (response) {
                        $("#tbProducts").html(response)
                        if (!signalRHubInitialized)
                            InitializeSignalRHubStore();
                    });
            };
        </script>
    }
